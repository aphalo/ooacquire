<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Algorithms • ooacquire</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">ooacquire</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Algorithms</h1>
            <h3 class="subtitle">
<code>ooacquire</code> 0.1.4.9003</h3>
                        <h4 class="author">Pedro J. Aphalo</h4>
            
            <h4 class="date">2017-09-29</h4>
          </div>

    
    
<div class="contents">
<div id="introdcution" class="section level2">
<h2 class="hasAnchor">
<a href="#introdcution" class="anchor"></a>Introdcution</h2>
<p>In this vignette we will walk through the different steps used in the conversion of raw counts into physical quantites. Different protocols can be used, and not all those implemented are exemplified. The facilities in the package also allow users to implement their own measurement and correction protocols. <em>It must be, however, always kept in mind that protocols and calibrations go hand in han:</em> <strong>For each different protocol new calibration data will be required</strong>. In many cases new calibration and validation measurements will be needed, but sometimes just recalculation of new calibration constants from existing raw-counts and calibration-lamp data may be enough.</p>
<hr>
</div>
<div id="code-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#code-examples" class="anchor"></a>Code examples</h2>
<p>All examples in vignettes use data and files included in the package. Data files in formats <em>foreign</em> to R, are stored in the <code>"extdata"</code> folder, as is the norm for R packages.</p>
<p><em>To reproduce any of the examples which use files as data input, it is best to make a local copy of the whole <code>"extdata"</code> folder.</em> The files used in examples are organized into subfolders, but all example code assumes that its in being run with <code>"extdata"</code> or a copy of it as the current <em>working</em> folder.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">folderpath &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>,<span class="dt">package=</span><span class="st">"ooacquire"</span>)
## file.copy(from = folderpath, to = ".", recursive = TRUE)</code></pre></div>
<hr>
</div>
<div id="irradiance" class="section level2">
<h2 class="hasAnchor">
<a href="#irradiance" class="anchor"></a>Irradiance</h2>
<p>We will step through the different steps of the algorithm used, plotting the spectra at each step along the way. We use raw counts data, included in the package, to make building this vignette easier. At the same time we show how raw data acquire outwith R can be also processed with the package.</p>
</div>
<div id="interactive-acquisition-of-spectral-irradiance" class="section level2">
<h2 class="hasAnchor">
<a href="#interactive-acquisition-of-spectral-irradiance" class="anchor"></a>Interactive acquisition of spectral irradiance</h2>
<p>We first load the R packages to be used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(ggspectra)
<span class="kw">library</span>(photobiology)
<span class="kw">library</span>(photobiologyWavebands)
<span class="kw">library</span>(ooacquire)
<span class="kw">library</span>(magrittr)</code></pre></div>
<div id="household-white-led-bulb" class="section level3">
<h3 class="hasAnchor">
<a href="#household-white-led-bulb" class="anchor"></a>Household white LED bulb</h3>
<p>We will read data from the measurement of the irradiance under a white LED light source—<em>Osram LED Star classic A 60 E27</em>. It was measured with a Ocean Optics, Maya 2000 Pro spectrometer, using the function <code>acquire_irrad_interactive()</code>.</p>
<p>We calculate irradiance from a set of raw-counts spectral data using a high-level function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LED_lamp_recalc.spct &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/s_irrad_corrected.html">s_irrad_corrected</a></span>(white_LED_2min.raw_mspct, 
                    <span class="dt">correction.method=</span> ooacquire<span class="op">::</span>MAYP11278_ylianttila.mthd)</code></pre></div>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values [-50.77..0.00]
## instead of [0..1]</code></pre>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values [-54.81..0.00]
## instead of [0..1]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(LED_lamp_recalc.spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(LED_lamp_recalc.spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>))</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-4-2.png" width="768"></p>
<p>We next print the collection of spectra containing raw counts data. The protocol used consisted in one light measurement and one dark measurement, each with bracketing of the integration time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">white_LED.raw_mspct</code></pre></div>
<pre><code>## Object: raw_mspct [3 x 1]
## --- Member: light ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## what label: light
## user.label label: osram06 
## Measured on 2016-12-01 10:08:16 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 0.32, 3.2
## total time (s): 5.11, 6.39
## counts @ peak (% of max): 94.3
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2302.500   2303.0
##  2   188.30 2220.688   2219.5
##  3   188.78 2190.250   2188.0
##  4   189.26 2192.938   2191.5
##  5   189.73 2593.625   6033.5
##  6   190.21 2629.500   6421.0
##  7   190.69 2645.625   6624.5
##  8   191.17 2658.125   6647.0
##  9   191.64 2690.375   6990.5
## 10   192.12 2658.312   6684.5
## # ... with 2,058 more rows
## --- Member: filter ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## what label: filter
## user.label label: osram06 
## Measured on 2016-12-01 10:08:16 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 0.32, 3.2
## total time (s): 5.11, 6.39
## counts @ peak (% of max): 94.3
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2299.500   2302.5
##  2   188.30 2219.312   2222.0
##  3   188.78 2189.125   2193.5
##  4   189.26 2189.875   2193.5
##  5   189.73 2595.438   5988.0
##  6   190.21 2624.000   6393.0
##  7   190.69 2635.000   6456.0
##  8   191.17 2634.000   6499.5
##  9   191.64 2668.438   6701.0
## 10   192.12 2635.375   6479.0
## # ... with 2,058 more rows
## --- Member: dark ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## what label: dark
## user.label label: osram06 
## Measured on 2016-12-01 10:08:16 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 0.32, 3.2
## total time (s): 5.11, 6.39
## counts @ peak (% of max): 94.3
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2301.062   2303.0
##  2   188.30 2218.625   2224.0
##  3   188.78 2190.000   2192.0
##  4   189.26 2192.188   2192.5
##  5   189.73 2589.750   6002.0
##  6   190.21 2624.500   6405.5
##  7   190.69 2634.500   6436.5
##  8   191.17 2634.250   6540.5
##  9   191.64 2663.062   6757.5
## 10   192.12 2637.812   6547.5
## # ... with 2,058 more rows
## 
## --- END ---</code></pre>
<p>Ploting the three bracketed spectra shows the raw data. The detector saturates at approximately 64000 counts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(white_LED_2min.raw_mspct[[<span class="st">"light"</span>]])</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(white_LED_2min.raw_mspct[[<span class="st">"dark"</span>]])</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>The first step in the processing is removal of bad pixels, as recorded in the calibration data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.raw_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/skip_bad_pixs.html">skip_bad_pixs</a></span>(white_LED_2min.raw_mspct[[m]])
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.raw_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-8-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-8-2.png" width="768"></p>
<p>Next step is to replace saturated pixel data, with the missing data marked <code>NA</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.raw_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/trim_counts.html">trim_counts</a></span>(white_LED_2min.raw_mspct[[m]])
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.raw_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<pre><code>## Warning: Removed 844 rows containing non-finite values (stat_peaks).</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-9-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-9-2.png" width="768"></p>
<p>Saturated pixels can affect the readings from nearby pixels through charge migration, so we need to also tag as <code>NA</code>s these additional pixels.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.raw_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/bleed_nas.html">bleed_nas</a></span>(white_LED_2min.raw_mspct[[m]])
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.raw_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<pre><code>## Warning: Removed 904 rows containing non-finite values (stat_peaks).</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-10-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-10-2.png" width="768"></p>
<p>Next we need to apply a linearization function, as detector response is not linear—saturation is gradual.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.raw_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/linearize_counts.html">linearize_counts</a></span>(white_LED_2min.raw_mspct[[m]])
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.raw_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<pre><code>## Warning: Removed 904 rows containing non-finite values (stat_peaks).</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-11-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-11-2.png" width="768"></p>
<p>We may next remove an estimate of dark signal based on reference pixels not expected to be excited. This step may apear redundant, but <em>might</em> help in cases when instrument temperature is not stable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.raw_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw">fshift</span>(white_LED_2min.raw_mspct[[m]], <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>,<span class="dv">290</span>))
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.raw_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<pre><code>## Warning: Removed 904 rows containing non-finite values (stat_peaks).</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-12-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-12-2.png" width="768"></p>
<p>Now we can convert the raw counts into counts per second.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">white_LED_2min.cps_mspct &lt;-<span class="st"> </span><span class="kw">cps_mspct</span>()
<span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.raw_mspct)) {
  white_LED_2min.cps_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/raw2cps.html">raw2cps</a></span>(white_LED_2min.raw_mspct[[m]])
  <span class="kw">print</span>(
    <span class="kw">ggplot</span>(white_LED_2min.cps_mspct[[m]], <span class="kw">aes</span>(<span class="dt">x =</span> w.length)) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> cps_<span class="dv">1</span>), <span class="dt">color =</span> <span class="st">"blue"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> cps_<span class="dv">2</span>), <span class="dt">color =</span> <span class="st">"red"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> cps_<span class="dv">3</span>), <span class="dt">color =</span> <span class="st">"green"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ggtitle</span>(m)
  )
}</code></pre></div>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values
## [-1611.57..702.83] instead of [0..1]</code></pre>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values
## [-1613.97..708.81] instead of [0..1]</code></pre>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values
## [-1630.93..714.15] instead of [0..1]</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-13-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-13-2.png" width="768"></p>
<p>Next splicing of the bracketed integrations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(white_LED_2min.cps_mspct)) {
  white_LED_2min.cps_mspct[[m]] &lt;-
<span class="st">    </span><span class="kw"><a href="../reference/merge_cps.html">merge_cps</a></span>(white_LED_2min.cps_mspct[[m]])
  <span class="kw">print</span>(<span class="kw">plot</span>(white_LED_2min.cps_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<pre><code>## Warning in range_check(x, cps.cols): Off-range cps values
## [-1630.93..714.15] instead of [0..1]

## Warning in range_check(x, cps.cols): Off-range cps values
## [-1630.93..714.15] instead of [0..1]</code></pre>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-14-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-14-2.png" width="768"></p>
<p>We now subtract the dark signal from the light measurement.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">white_LED_2min.cps_spct &lt;-<span class="st"> </span>
<span class="st">  </span>white_LED_2min.cps_mspct[[<span class="st">"light"</span>]] <span class="op">-</span><span class="st"> </span>white_LED_2min.cps_mspct[[<span class="st">"dark"</span>]]
white_LED_2min.cps_spct &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">copy_attributes</span>(white_LED_2min.raw_mspct[[<span class="st">"light"</span>]],
                  white_LED_2min.cps_spct,
                  <span class="dt">copy.class =</span> <span class="ot">FALSE</span>)
<span class="kw">plot</span>(white_LED_2min.cps_spct) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">"Dark subtracted"</span>)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-15-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">white_LED_2min.spct &lt;-<span class="st"> </span><span class="kw">cps2irrad</span>(white_LED_2min.cps_spct)
<span class="kw">plot</span>(white_LED_2min.spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-16-1.png" width="768"></p>
<p>We can finally smooth-out some of the noise.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">white_LED_2min.spct &lt;-<span class="st"> </span><span class="kw">smooth_spct</span>(white_LED_2min.spct)</code></pre></div>
<pre><code>## Warning in smooth_spct.source_spct(white_LED_2min.spct): 637 'bad'
## estimates in spectral irradiance</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(white_LED_2min.spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-17-1.png" width="768"> With an LED source, at least in the case of our Maya 2000 Pro, we do not need to worry about stray light. However, when we measure light sources with a significant emission in the infra-red above 1000 nm, stray light becomes a problem. In addition sources with narrow peaks of emission may benefit from deconvolution of a measured slit function.</p>
</div>
<div id="tungsten-halogen-lamp" class="section level3">
<h3 class="hasAnchor">
<a href="#tungsten-halogen-lamp" class="anchor"></a>Tungsten halogen lamp</h3>
<p>We calculate irradiance from a set of raw-counts spectral data using a high-level function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">halogen.spct &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/s_irrad_corrected.html">s_irrad_corrected</a></span>(halogen.raw_mspct, <span class="dt">correction.method=</span> MAYP11278_ylianttila.mthd)
<span class="kw">plot</span>(halogen.spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-18-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen.spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>))</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-18-2.png" width="768"></p>
<p>We print the object with the raw counts data. The protocol used, in this case included a measurement with a UV-pass filter (polycarbonate).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">halogen.raw_mspct</code></pre></div>
<pre><code>## Object: raw_mspct [3 x 1]
## --- Member: light ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:24:35 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2288.333     2285
##  2   188.30 2210.000     2211
##  3   188.78 2182.333     2180
##  4   189.26 2181.667     2184
##  5   189.73 3865.000     8578
##  6   190.21 4119.667     9494
##  7   190.69 4114.000     9675
##  8   191.17 4178.667     9918
##  9   191.64 4310.000    10366
## 10   192.12 4189.667     9875
## # ... with 2,058 more rows
## --- Member: filter ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:25:54 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2290.333     2290
##  2   188.30 2212.333     2213
##  3   188.78 2183.333     2182
##  4   189.26 2181.333     2186
##  5   189.73 3924.667     8693
##  6   190.21 4178.333     9735
##  7   190.69 4188.333     9861
##  8   191.17 4262.000    10140
##  9   191.64 4397.333    10548
## 10   192.12 4229.333    10135
## # ... with 2,058 more rows
## --- Member: dark ---
## Object: raw_spct [2,068 x 3]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:26:36 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 3
##    w.length counts_1 counts_2
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1   187.82 2287.667     2290
##  2   188.30 2211.667     2209
##  3   188.78 2182.667     2185
##  4   189.26 2182.667     2183
##  5   189.73 3816.000     8408
##  6   190.21 4053.667     9346
##  7   190.69 4000.333     9231
##  8   191.17 4062.000     9404
##  9   191.64 4179.667     9863
## 10   192.12 4053.000     9350
## # ... with 2,058 more rows
## 
## --- END ---</code></pre>
<p>We first use a “pipe” to apply the same initial processing steps as for the LED bulb data in the previous section.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">halogen.cps_mspct &lt;-<span class="st"> </span><span class="kw">cps_mspct</span>()
<span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(halogen.raw_mspct)) {
  halogen.raw_mspct[[m]] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/skip_bad_pixs.html">skip_bad_pixs</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/trim_counts.html">trim_counts</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/bleed_nas.html">bleed_nas</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/linearize_counts.html">linearize_counts</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fshift</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="fl">187.82</span>,<span class="fl">189.26</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/raw2cps.html">raw2cps</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="../reference/merge_cps.html">merge_cps</a></span>() -&gt;<span class="st"> </span>halogen.cps_mspct[[m]]
}
halogen.cps_mspct</code></pre></div>
<pre><code>## Object: cps_mspct [3 x 1]
## --- Member: light ---
## Object: cps_spct [2,068 x 2]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:24:35 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 2
##    w.length          cps
##       &lt;dbl&gt;        &lt;dbl&gt;
##  1   187.82   10.6009359
##  2   188.30    0.3464329
##  3   188.78   -3.9493661
##  4   189.26   -3.3950696
##  5   189.73  884.2018178
##  6   190.21 1011.9826105
##  7   190.69 1037.2621437
##  8   191.17 1071.2176472
##  9   191.64 1133.8706633
## 10   192.12 1065.2076455
## # ... with 2,058 more rows
## --- Member: filter ---
## Object: cps_spct [2,068 x 2]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:25:54 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 2
##    w.length          cps
##       &lt;dbl&gt;        &lt;dbl&gt;
##  1   187.82   10.9473729
##  2   188.30    0.2771456
##  3   188.78   -4.0186536
##  4   189.26   -3.4643571
##  5   189.73  899.8843479
##  6   190.21 1045.2979871
##  7   190.69 1062.9045973
##  8   191.17 1101.9094513
##  9   191.64 1158.9968896
## 10   192.12 1101.2102082
## # ... with 2,058 more rows
## --- Member: dark ---
## Object: cps_spct [2,068 x 2]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:26:36 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 2
##    w.length          cps
##       &lt;dbl&gt;        &lt;dbl&gt;
##  1   187.82   11.0628515
##  2   188.30   -0.1616727
##  3   188.78   -3.4874526
##  4   189.26   -3.7646009
##  5   189.73  860.2825093
##  6   190.21  991.0887877
##  7   190.69  975.0378660
##  8   191.17  999.1855825
##  9   191.64 1063.2995879
## 10   192.12  991.6471539
## # ... with 2,058 more rows
## 
## --- END ---</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(halogen.cps_mspct)) {
  <span class="kw">print</span>(<span class="kw">plot</span>(halogen.cps_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
  <span class="kw">print</span>(<span class="kw">plot</span>(halogen.cps_mspct[[m]], <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-2.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-3.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-4.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-5.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-21-6.png" width="768"></p>
<p>We substract the dark reading from both the light and filter measurements, and copy attributes, including instrument settings and calibration data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">halogen01.cps_mspct &lt;-<span class="st"> </span><span class="kw">cps_mspct</span>()
<span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">setdiff</span>(<span class="kw">names</span>(halogen.cps_mspct), <span class="st">"dark"</span>)) {
  halogen01.cps_mspct[[m]] &lt;-<span class="st"> </span>halogen.cps_mspct[[m]] <span class="op">-</span><span class="st"> </span>halogen.cps_mspct[[<span class="st">"dark"</span>]]
  halogen01.cps_mspct[[m]] &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">copy_attributes</span>(halogen.cps_mspct[[m]],
                    halogen01.cps_mspct[[m]],
                    <span class="dt">copy.class =</span> <span class="ot">FALSE</span>)
}
halogen01.cps_mspct</code></pre></div>
<pre><code>## Object: cps_mspct [2 x 1]
## --- Member: light ---
## Object: cps_spct [2,068 x 2]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:24:35 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 2
##    w.length        cps
##       &lt;dbl&gt;      &lt;dbl&gt;
##  1   187.82 -0.4619156
##  2   188.30  0.5081056
##  3   188.78 -0.4619134
##  4   189.26  0.3695313
##  5   189.73 23.9193085
##  6   190.21 20.8938227
##  7   190.69 62.2242777
##  8   191.17 72.0320647
##  9   191.64 70.5710754
## 10   192.12 73.5604916
## # ... with 2,058 more rows
## --- Member: filter ---
## Object: cps_spct [2,068 x 2]
## Wavelength range 187.82 to 1117.14 nm, step 0.41 to 0.48 nm 
## Label: Halogen 
## Measured on 2017-03-28 11:25:54 UTC 
## Data acquired with 'MayaPro2000' s.n. MAYP11278
## grating 'HC1', slit '010s'
## integ. time (s): 1.86, 7.2
## total time (s): 5.58, 7.2
## counts @ peak (% of max): 94.4
## 
## # A tibble: 2,068 x 2
##    w.length         cps
##       &lt;dbl&gt;       &lt;dbl&gt;
##  1   187.82  -0.1154786
##  2   188.30   0.4388183
##  3   188.78  -0.5312009
##  4   189.26   0.3002438
##  5   189.73  39.6018386
##  6   190.21  54.2091993
##  7   190.69  87.8667313
##  8   191.17 102.7238688
##  9   191.64  95.6973017
## 10   192.12 109.5630543
## # ... with 2,058 more rows
## 
## --- END ---</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (m <span class="cf">in</span> <span class="kw">names</span>(halogen01.cps_mspct)) {
  <span class="kw">print</span>(<span class="kw">plot</span>(halogen01.cps_mspct[[m]]) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
  <span class="kw">print</span>(<span class="kw">plot</span>(halogen01.cps_mspct[[m]], <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(m))
}</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-23-1.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-23-2.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-23-3.png" width="768"><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-23-4.png" width="768"></p>
<p>As we can see in the plots above, a small amount of stray light is present in both spectra in the UV region. We apply a filter correction using a simple method based on a fixed transmittance value. By trial an error a flt.Tfr value &gt; 1 gives best correction, which is odd…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">halogen_corrected.cps_spct &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/filter_correction.html">filter_correction</a></span>(halogen01.cps_mspct[[<span class="st">"light"</span>]], 
                    halogen01.cps_mspct[[<span class="st">"filter"</span>]],
                    <span class="dt">stray.light.method =</span> <span class="st">"original"</span>,
                    <span class="dt">flt.Tfr =</span> <span class="fl">1.4</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen_corrected.cps_spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen_corrected.cps_spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>))</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-25-2.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">clip_wl</span>(halogen_corrected.cps_spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">300</span>))[[<span class="st">"cps"</span>]])</code></pre></div>
<pre><code>## [1] 2.747068</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cps2irrad</span>(halogen_corrected.cps_spct) -&gt;<span class="st"> </span>halogen.source_spct</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen.source_spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-27-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen.source_spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>))</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-27-2.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">q_ratio</span>(halogen.source_spct, <span class="kw">list</span>(<span class="kw">UVC</span>(), <span class="kw">UVB</span>(), <span class="kw">UVA</span>()), <span class="kw">PAR</span>()) <span class="op">*</span><span class="st"> </span><span class="fl">1e3</span></code></pre></div>
<pre><code>##  UVC.ISO.tr.lo: PAR(q:q)        UVB.ISO: PAR(q:q)        UVA.ISO: PAR(q:q) 
##                0.1925562                0.3494061                3.2901570 
## attr(,"radiation.unit")
## [1] "q:q ratio"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cps2irrad</span>(halogen_corrected.cps_spct) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">smooth_spct</span>(<span class="dt">method =</span> <span class="st">"supsmu"</span>, <span class="dt">strength =</span> <span class="dv">3</span>) -&gt;<span class="st"> </span>halogen.source_spct</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen.source_spct)</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-30-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(halogen.source_spct, <span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">250</span>, <span class="dv">410</span>))</code></pre></div>
<p><img src="c-algorithm-step-through_files/figure-html/unnamed-chunk-30-2.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">q_ratio</span>(halogen.source_spct, <span class="kw">list</span>(<span class="kw">UVC</span>(), <span class="kw">UVB</span>(), <span class="kw">UVA</span>()), <span class="kw">PAR</span>()) <span class="op">*</span><span class="st"> </span><span class="fl">1e3</span></code></pre></div>
<pre><code>##  UVC.ISO.tr.lo: PAR(q:q)        UVB.ISO: PAR(q:q)        UVA.ISO: PAR(q:q) 
##                0.2395183                0.3434062                3.4877545 
## attr(,"radiation.unit")
## [1] "q:q ratio"</code></pre>
</div>
</div>
<div id="coming-soon" class="section level2">
<h2 class="hasAnchor">
<a href="#coming-soon" class="anchor"></a>Coming soon</h2>
<p>Step by step application of slit fucntion tail correction.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introdcution">Introdcution</a></li>
      <li><a href="#code-examples">Code examples</a></li>
      <li><a href="#irradiance">Irradiance</a></li>
      <li><a href="#interactive-acquisition-of-spectral-irradiance">Interactive acquisition of spectral irradiance</a></li>
      <li><a href="#coming-soon">Coming soon</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Pedro J. Aphalo, Lasse Ylianttila.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
