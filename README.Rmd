---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r readme-01, echo = FALSE}
knitr::opts_chunk$set(
  fig.asp = 2/3,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# ooacquire <img src="man/figures/logo.png" align="right" width="120" />

## Purpose

Package **'ooacquire'** makes it possible to control, modify settings and acquire spectral data directly from within R. It also supports the conversion of raw-counts data into physical quantities. It supports most types of spectrometers available from former _Ocean Optics_, now _Ocean Insight_ (<https://www.oceaninsight.com/>).
The free runtime of the [_OmniDriver SDP_](https://www.oceaninsight.com/products/software/drivers/omnidriver-and-spam/) and _Java_ need both to be installed before data acquisition is possible. The runtime itself and its documentation can be downloaded at <https://www.oceaninsight.com/support/software-downloads/>.

## Details

Package **'ooacquire'** provides high level functions for spectral data acquisition built using lower level functions from package **'rOmniDriver'** as a base. Acquisition is very flexible with respect to measuring protocols. It caters for all steps involved in the acquisition of spectral data from connecting to the instrument(s) and retrieving information from non-volatile memory, setting and adjusting acquisition parameters, acquiring raw counts and converting them into counts per second. It supports bracketing of the integration time for high dynamic range (HDR) protocols, both with respect to data acquisition and merging/splicing of spectra. It also supports protocols in which the total measuring time is kept constant by adjusting in coordination integration time and number of scans averaged. It works seamlessly together with package **photobiology** on which it also depends.

In addition to directly acquiring RAW counts data, raw-counts data can be read from files with automatic decoding of the corresponding acquisition metadata from file headers. Files saved by _OceanView_ or _SpectraSuite_ software from Ocean Optics, or directly by Jaz spectrometers can be read. Raw data read from files and acquired directly is stored in the same format. Consequently, data from either origin can be used as the starting point for the computation of spectra expressed as corrected counts-per-second with the same flexibility and code.

High level functions in this package and in package **photobiology** allow the easy conversion of counts-per-second into the physical quantities of interest such as spectral irradiance, spectral transmittance, spectral reflectance, spectral absorptance and spectral absorbance. 

Our package's functions related to direct data acquisition use the free _OmniDriver_ run-time which in turn requires _Java_. There is no other set up needed, just plug your spectrometer to an USB port. The first time you connect an instrument the operating system will install the drivers as they are made available by the _OmniDriver_ installation.

Direct acquisition has been tested with our _Maya2000Pro_, _Flame_ and _Jaz_ instruments under MS-windows 7 and MS-Windows 10, but can be expected also to work with any other modern spectrometer from Ocean Optics, and under OS X, and Linux. Package **'ooacquire'** manages acquisition settings semi-automatically storing all the settings needed for acquisition into a single data object. Functions for automatic tuning of integration time are also provided. Settings used for acquisition of spectra and a descriptor of the instrument are stored at the time of acquisition as attributes of the object where the raw counts are stored. These metadata are preserved through all processing steps.

## Technical aspects

Package **'rOmniDriver'** makes available in R the API functions from the _OmniDriver SDP_ by wrapping the Java calls in R functions of the same name and doing argument type conversions when needed. _OmniDriver_ allows to change settings and acquire spectra using any Ocean Optics USB-connected spectrometer. 

## Installation

At the moment installation needs to be done from the Git repository at Bitbucket.
For this we can use 'devtools' and as the package's is coded mainly in R but 
with one function in C++ the build chain for R packages needs to be installed.
In MS-Windows this is achieved by installing Rtools.

Assuming that R and the build tools are installed the following software should
be installed in sequence:

  1. **Java JDK** (Java development kit). The Java run-time is not enough.
  2. **rOmniDriver run-time** from Ocean Optics which is a free download. It is the
  same installer as for the non-free SDP, but if run-time is selected
  during installation no key/password are asked for.
  3. Install the **R packages** 'photobiology' and 'ggspectra' plus the 'tidyverse',
  all available from CRAN.
  4. Install 'rOmniDriver' and 'ooacquire' from Bitbucket.
  
Installation of the current version from GitHub:
```{r bb-installation, eval=FALSE}
# install.packages("devtools")
devtools::install_github("aphalo/rOmniDriver")
devtools::install_github("aphalo/ooacquire")
```

The package includes calibration data for the spectrometers used in testing the
package and that are used by myself and collaborators. The last step before
being able to use the package is to obtain calibration data for the spectrometers
to be used and their descriptor and saving them in a suitable format. At least one correction method needs also to be defined for each spectrometer. Depending on
how detailed has been the characterization of the spectrometer different
corrections are possible. The source package includes a folder 'data-raw' with
examples of how this can be done. The process cannot be easily automated 
as bad pixels and suitable reference wavelengths need to be chosen based both
on the instrument used and light source to be measured.

## Documentation and examples

Documentation includes four vignettes in addition to help pages. The examples in
the vignettes and help pages use spectral data from measurements done with this
package as well as output files created by Ocean Optics's software. These data
files are in folder `exdata`. Scripts containing examples that can be in most
cases used with only small changes are in folder `example-scripts` of this
package.

## Examples

A simple example using no dark reference scans.

```{r example-1, message = FALSE}
library(ooacquire)
folderpath <- system.file("extdata", package = "ooacquire")
file_names <- list(light = paste(folderpath, 
                                 "irrad-files/light-short.txt", sep = "/"))
one_file.spct <- 
  s_irrad_corrected(x = file_names,
                    descriptor = which_descriptor("2016-10-11" , 
                                                  MAYP11278_descriptors),
                    correction.method = MAYP11278_ylianttila.mthd)
autoplot(one_file.spct, unit.out = "photon", range = c(300, 850))
```

## Non-commercial status

Packages **'rOmniDriver'** and  **'ooacquire'** are both open source and released under a GPL license. Neither **'rOmniDriver'** nor **'ooacquire'** require the commercial software _OceanView_ or _SpectraSuite_ to be installed, but should be able to coexist with either of them. They do not require the purchase of any software from Ocean Optics, but the use of these packages or the free _OmniDriver_ runtime is not supported in any way by Ocean Optics, unless you acquire a license to the _OmniDriver SDP_. The _OmniDriver SDP_ is not open source and is proprietary software copyrighted by Ocean Optics and supporting only the use of hardware sold by this company (https://oceanoptics.com/).

## Documentation 

HTML documentation is available at (https://docs.r4photobiology.info/ooacquire/), including a _User Guide_ and a description of the algorithms.

News about updates are regularly posted at (https://www.r4photobiology.info/).

## Contributing

Please report bugs and request new features at (https://bitbucket.org/aphalo/ooacquire/issues). Pull requests are welcome at (https://bitbucket.org/aphalo/ooacquire).

## Citation

If you use this package to produce scientific or commercial publications, please cite according to:

```{r}
citation("ooacquire")
```

## License

Â© 2016-2021 Pedro J. Aphalo (pedro.aphalo@helsinki.fi) for the code. Lasse Ylianttila developed the majority of the algorithms used. Released under the GPL, version 2 or greater. This software carries no warranty of any kind.
